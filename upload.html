<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Carga de Documentos - Evaluación</title>
    <link href="https://fonts.googleapis.com/css2?family=Lato:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/style.css"> 
    <style>
        /* --- ESTILOS ADICIONALES PARA EL ASISTENTE (v3.4) --- */

        /* Contenedor principal de una sola columna */
        .container-upload {
            max-width: 900px;
            margin: 40px auto;
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
            overflow: hidden;
        }
        .form-col {
            width: 100%;
            border-left: none;
            border-top: 5px solid #007bff;
            padding: 30px 40px; 
            box-sizing: border-box;
        }

        /* Ocultamos los pasos futuros */
        #paso-2-formulario, #paso-3-checklist, #paso-4-uploader {
            display: none;
            margin-top: 30px;
            animation: fadeIn 0.5s;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* --- Estilos para el Perfil (Paso 1) --- */
        .profile-selector { display: flex; flex-direction: column; gap: 10px; }
        .profile-selector label { display: block; padding: 15px 20px; border: 1px solid #ccc; border-radius: 5px; cursor: pointer; transition: background-color 0.2s; }
        .profile-selector input[type="radio"] { margin-right: 12px; accent-color: #005a9c; }
        .profile-selector label:hover { background-color: #f4f7f6; }
        .profile-selector input[type="radio"]:checked + span { font-weight: 700; color: #005a9c; }

        /* --- Estilos para el Formulario (Paso 2) --- */
        .tab-navigation {
            display: flex;
            flex-wrap: wrap; 
            border-bottom: 2px solid #ccc;
            margin-bottom: 20px;
        }
        .tab-nav-button {
            padding: 10px 15px; 
            border: none;
            background-color: #f4f7f6;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            margin-bottom: -2px;
            font-size: 0.95em;
            font-weight: 600;
        }
        .tab-nav-button.active {
            background-color: #fff;
            border-top: 1px solid #ccc;
            border-left: 1px solid #ccc;
            border-right: 1px solid #ccc;
            border-bottom: 2px solid #fff;
            color: #005a9c;
        }
        .tab-content { display: none; animation: fadeIn 0.3s; }
        .tab-content.active { display: block; }
        
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }
        .form-grid .input-group { margin-bottom: 0; }
        
        /* Ocultar pestañas de Codeudor por defecto */
        .codeudor-tab { display: none; }
        /* ¡NUEVO! Ocultar sub-contenidos dinámicos */
        .codeudor-sub-content { display: none; }
        #perfil-codeudor-selector { display: none; margin-top: 20px; }


        .form-navigation-buttons { display: flex; justify-content: space-between; margin-top: 20px; }
        .form-nav-btn { padding: 12px 25px; background-color: #005a9c; color: white; border: none; border-radius: 5px; font-size: 1em; font-weight: 700; cursor: pointer; }
        .form-nav-btn:disabled { background-color: #aaa; cursor: not-allowed; }
        .form-nav-btn.secondary { background-color: #6c757d; }
        #btn-finalizar-formulario { background-color: #28a745; display: none; } 
        #btn-form-next { display: inline-block; } 

        /* --- Estilos para el Checklist (Paso 3) --- */
        .checklist { list-style: none; padding-left: 0; background-color: #f9f9f9; border: 1px solid #eee; border-radius: 8px; padding: 20px; }
        .checklist li { font-size: 1.1em; padding: 12px 10px; border-bottom: 1px solid #e0e0e0; display: flex; justify-content: space-between; align-items: center; }
        .checklist li:last-child { border-bottom: none; }
        .checklist li strong { color: #333; }
        .checklist li .doc-help { font-weight: 700; text-decoration: none; color: #005a9c; margin-left: 10px; white-space: nowrap; }

        /* --- Estilos para el Uploader (Paso 4) --- */
        #fileInput { border: 2px dashed #007bff; padding: 20px; border-radius: 5px; cursor: pointer; text-align: center; }
        .file-list { margin-top: 15px; font-style: italic; }

        /* Hack para quitar flechas en campos de número */
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { 
            -webkit-appearance: none; 
            margin: 0; 
        }
        input[type=number] {
            -moz-appearance: textfield;
        }

    </style>
</head>
<body>

    <div class="container-upload">
        <div class="form-col">

            <div id="paso-1-perfil">
                <h2>Paso 1: ¿Cuál es tu perfil?</h2>
                <p>Selecciona tu situación laboral para mostrarte los documentos exactos que necesitamos.</p>
                <div class="profile-selector">
                    <label><input type="radio" name="perfilCliente" value="dependiente"><span>Soy Trabajador <strong>Dependiente</strong> (con contrato)</span></label>
                    <label><input type="radio" name="perfilCliente" value="independiente"><span>Soy Trabajador <strong>Independiente</strong> (boletas de honorarios)</span></label>
                    <label><input type="radio" name="perfilCliente" value="empresa"><span>Soy <strong>Empresa</strong> (tengo mi propia sociedad)</span></label>
                </div>
            </div>

            <div id="paso-2-formulario">
                <h2>Paso 2: Completa tu "Estado de Situación"</h2>
                <p>Por favor, completa estos datos para agilizar tu evaluación.</p>
                
                <form id="eessForm">
                    <div class="tab-navigation">
                        <button type="button" class="tab-nav-button active" data-tab="tab-titular">1. Titular</button>
                        <button type="button" class="tab-nav-button" data-tab="tab-laboral-titular" id="tab-nav-laboral-titular">2. Laboral (Titular)</button>
                        <button type="button" class="tab-nav-button" data-tab="tab-activos-titular">3. Activos (Titular)</button>
                        <button type="button" class="tab-nav-button codeudor-tab" data-tab="tab-codeudor">4. Codeudor</button>
                        <button type="button" class="tab-nav-button codeudor-tab" data-tab="tab-laboral-codeudor" id="tab-nav-laboral-codeudor">5. Laboral (Codeudor)</button>
                        <button type="button" class="tab-nav-button codeudor-tab" data-tab="tab-activos-codeudor" id="tab-nav-activos-codeudor">6. Activos (Codeudor)</button>
                        <button type="button" class="tab-nav-button" data-tab="tab-pasivos">Últ. Pasivos (Deudas)</button>
                    </div>

                    <div id="tab-titular" class="tab-content active">
                        <h3>Datos del Titular</h3>
                        <div class="form-grid">
                            <div class="input-group"><label for="titular_nombre">Nombre Completo</label><input type="text" id="titular_nombre" name="titular_nombre" required></div>
                            <div class="input-group"><label for="titular_rut">RUT</label><input type="text" id="titular_rut" name="titular_rut" placeholder="Ej: 12.345.678-9" required oninput="formatearRUT(this)"></div>
                            <div class="input-group"><label for="titular_email">Email</label><input type="email" id="titular_email" name="titular_email" required></div>
                            <div class="input-group"><label for="titular_telefono">Teléfono</label><input type="tel" id="titular_telefono" name="titular_telefono" placeholder="Ej: +56912345678" required></div>
                            <div class="input-group"><label for="titular_fecha_nac">Fecha Nacimiento</label><input type="date" id="titular_fecha_nac" name="titular_fecha_nac"></div>
                            
                            <div class="input-group"><label for="titular_nacionalidad">Nacionalidad</label>
                                <select id="titular_nacionalidad" name="titular_nacionalidad">
                                    <option value="">Selecciona...</option>
                                    <option value="Chilena">Chilena</option>
                                    <option value="Peruana">Peruana</option>
                                    <option value="Venezolana">Venezolana</option>
                                    <option value="Colombiana">Colombiana</option>
                                    <option value="Argentina">Argentina</option>
                                    <option value="Boliviana">Boliviana</option>
                                    <option value="Ecuatoriana">Ecuatoriana</option>
                                    <option value="Haitiana">Haitiana</option>
                                    <option value="Otra">Otra</option>
                                </select>
                            </div>

                            <div class="input-group"><label for="titular_estado_civil">Estado Civil</label>
                                <select id="titular_estado_civil" name="titular_estado_civil">
                                    <option value="">Selecciona...</option>
                                    <option value="Soltero(a)">Soltero(a)</option>
                                    <option value="Casado(a)">Casado(a)</option>
                                    <option value="Divorciado(a)">Divorciado(a)</option>
                                    <option value="Viudo(a)">Viudo(a)</option>
                                    <option value="AUC">Acuerdo de Unión Civil</option>
                                </select>
                            </div>
                            <div class="input-group"><label for="titular_regimen">Régimen conyugal</label>
                                <select id="titular_regimen" name="titular_regimen">
                                    <option value="">Selecciona...</option>
                                    <option value="Separación de Bienes">Separación de Bienes</option>
                                    <option value="Sociedad Conyugal">Sociedad Conyugal</option>
                                    <option value="Participación en Gananciales">Participación en Gananciales</option>
                                    <option value="No Aplica">No Aplica</option>
                                </select>
                            </div>
                            <div class="input-group"><label for="titular_domicilio">Domicilio Particular</label><input type="text" id="titular_domicilio" name="titular_domicilio"></div>
                            
                            <div class="input-group"><label for="titular_region">Región</label>
                                <select id="titular_region" name="titular_region"></select>
                            </div>
                            <div class="input-group"><label for="titular_comuna">Comuna</label>
                                <select id="titular_comuna" name="titular_comuna"></select>
                            </div>

                            <div class="input-group"><label for="titular_profesion">Profesión</label><input type="text" id="titular_profesion" name="titular_profesion"></div>
                        </div>
                        <hr style="margin: 20px 0;">
                        <h3>Codeudor</h3>
                        <p>¿Vas a complementar renta con alguien (cónyuge, pareja, familiar, etc.)?</p>
                        <div class="profile-selector" style="flex-direction: row; gap: 20px;">
                            <label><input type="radio" name="complementa_renta" value="no" checked><span>No, postulo solo</span></label>
                            <label><input type="radio" name="complementa_renta" value="si"><span><strong>Sí</strong>, complemento renta</span></label>
                        </div>
                    </div>

                    <div id="tab-laboral-titular" class="tab-content">
                        <h3 id="titulo-laboral-titular">Antecedentes Laborales (Titular)</h3>
                        <div id="content-lab-titular-dep" class="form-grid">
                            <div class="input-group"><label for="lab_titular_empleador">Empleador</label><input type="text" id="lab_titular_empleador" name="lab_titular_empleador"></div>
                            <div class="input-group"><label for="lab_titular_rut_empleador">RUT Empleador</label><input type="text" id="lab_titular_rut_empleador" name="lab_titular_rut_empleador" placeholder="Ej: 76.123.456-7" oninput="formatearRUT(this)"></div>
                            <div class="input-group"><label for="lab_titular_cargo">Cargo</label><input type="text" id="lab_titular_cargo_dep" name="lab_titular_cargo"></div>
                            <div class="input-group"><label for="lab_titular_telefono">Teléfono Laboral</label><input type="tel" id="lab_titular_telefono" name="lab_titular_telefono"></div>
                            <div class="input-group"><label for="lab_titular_direccion">Dirección Laboral</label><input type="text" id="lab_titular_direccion" name="lab_titular_direccion"></div>
                            <div class="input-group"><label for="lab_titular_fecha_ingreso">Fecha de ingreso</label><input type="date" id="lab_titular_fecha_ingreso" name="lab_titular_fecha_ingreso"></div>
                        </div>
                        <div id="content-lab-titular-ind" class="form-grid" style="display: none;">
                            <div class="input-group"><label for="lab_titular_actividad">Actividad Económica</label><input type="text" id="lab_titular_actividad" name="lab_titular_actividad"></div>
                            <div class="input-group"><label for="lab_titular_fecha_ia">Fecha Inicio Actividades</label><input type="date" id="lab_titular_fecha_ia" name="lab_titular_fecha_ia"></div>
                        </div>
                    </div>

                    <div id="tab-activos-titular" class="tab-content">
                        <h3>Antecedentes Financieros (Titular)</h3>
                        <h4>Ingresos Mensuales</h4>
                        <div id="content-act-titular-dep" class="form-grid">
                            <div class="input-group"><label for="fin_titular_sueldo">Sueldo (Líquido)</label><input type="text" inputmode="numeric" id="fin_titular_sueldo" name="fin_titular_sueldo" placeholder="Ej: 1500000 (lo que llega a tu cuenta)"></div>
                        </div>
                        <div id="content-act-titular-ind" class="form-grid" style="display: none;">
                            <div class="input-group"><label for="fin_titular_honorarios">Honorarios (Prom. Mensual)</label><input type="text" inputmode="numeric" id="fin_titular_honorarios" name="fin_titular_honorarios" placeholder="Promedio de tus últimas 6 boletas"></div>
                            <div class="input-group"><label for="fin_titular_retiros">Retiros</label><input type="text" inputmode="numeric" id="fin_titular_retiros" name="fin_titular_retiros" placeholder="Si eres dueño de empresa"></div>
                        </div>
                         <div class="form-grid" style="margin-top: 10px;">
                           <div class="input-group"><label for="fin_titular_arriendos">Arriendos (Ingreso)</label><input type="text" inputmode="numeric" id="fin_titular_arriendos" name="fin_titular_arriendos" placeholder="Si recibes arriendos"></div>
                        </div>
                        
                        <h4 style="margin-top: 20px;">Ahorros (Pie)</h4>
                        <div class="form-grid">
                            <div class="input-group"><label for="fin_titular_ahorros">Ahorros (Cta. Ahorro)</label><input type="text" inputmode="numeric" id="fin_titular_ahorros" name="fin_titular_ahorros"></div>
                            <div class="input-group"><label for="fin_titular_dap">Depósito a Plazo</label><input type="text" inputmode="numeric" id="fin_titular_dap" name="fin_titular_dap"></div>
                            <div class="input-group"><label for="fin_titular_ffmm">Fondos Mutuos</label><input type="text" inputmode="numeric" id="fin_titular_ffmm" name="fin_titular_ffmm"></div>
                        </div>
                    </div>

                    <div id="tab-codeudor" class="tab-content">
                        <h3>Datos del Codeudor</h3>
                        <div class="form-grid">
                            <div class="input-group"><label for="codeudor_nombre">Nombre Completo</label><input type="text" id="codeudor_nombre" name="codeudor_nombre"></div>
                            <div class="input-group"><label for="codeudor_rut">RUT</label><input type="text" id="codeudor_rut" name="codeudor_rut" placeholder="Ej: 12.345.678-9" oninput="formatearRUT(this)"></div>
                            <div class="input-group"><label for="codeudor_email">Email</label><input type="email" id="codeudor_email" name="codeudor_email"></div>
                            <div class="input-group"><label for="codeudor_telefono">Teléfono</label><input type="tel" id="codeudor_telefono" name="codeudor_telefono"></div>
                            <div class="input-group"><label for="codeudor_fecha_nac">Fecha Nacimiento</label><input type="date" id="codeudor_fecha_nac" name="codeudor_fecha_nac"></div>
                            <div class="input-group"><label for="codeudor_profesion">Profesión</label><input type="text" id="codeudor_profesion" name="codeudor_profesion"></div>
                        </div>

                        <div id="perfil-codeudor-selector">
                            <hr style="margin: 20px 0;">
                            <h4>¿Cuál es el perfil de tu codeudor?</h4>
                            <div class="profile-selector">
                                <label><input type="radio" name="perfilCodeudor" value="dependiente" checked><span>Es Trabajador <strong>Dependiente</strong></span></label>
                                <label><input type="radio" name="perfilCodeudor" value="independiente"><span>Es Trabajador <strong>Independiente</strong></span></label>
                            </div>
                        </div>
                    </div>

                    <div id="tab-laboral-codeudor" class="tab-content">
                        <h3 id="titulo-laboral-codeudor">Antecedentes Laborales (Codeudor)</h3>
                        <div id="content-lab-codeudor-dep" class="form-grid codeudor-sub-content">
                            <div class="input-group"><label for="lab_codeudor_empleador">Empleador</label><input type="text" id="lab_codeudor_empleador" name="lab_codeudor_empleador"></div>
                            <div class="input-group"><label for="lab_codeudor_rut_empleador">RUT Empleador</label><input type="text" id="lab_codeudor_rut_empleador" name="lab_codeudor_rut_empleador" oninput="formatearRUT(this)"></div>
                            <div class="input-group"><label for="lab_codeudor_cargo">Cargo</label><input type="text" id="lab_codeudor_cargo" name="lab_codeudor_cargo"></div>
                            <div class="input-group"><label for="lab_codeudor_fecha_ingreso">Fecha de ingreso</label><input type="date" id="lab_codeudor_fecha_ingreso" name="lab_codeudor_fecha_ingreso"></div>
                        </div>
                        <div id="content-lab-codeudor-ind" class="form-grid codeudor-sub-content" style="display: none;">
                            <div class="input-group"><label for="lab_codeudor_actividad">Actividad Económica</label><input type="text" id="lab_codeudor_actividad" name="lab_codeudor_actividad"></div>
                            <div class="input-group"><label for="lab_codeudor_fecha_ia">Fecha Inicio Actividades</label><input type="date" id="lab_codeudor_fecha_ia" name="lab_codeudor_fecha_ia"></div>
                        </div>
                    </div>

                    <div id="tab-activos-codeudor" class="tab-content">
                        <h3>Antecedentes Financieros (Codeudor)</h3>
                        <h4>Ingresos Mensuales</h4>
                        <div id="content-act-codeudor-dep" class="form-grid codeudor-sub-content">
                            <div class="input-group"><label for="fin_codeudor_sueldo">Sueldo (Líquido)</label><input type="text" inputmode="numeric" id="fin_codeudor_sueldo" name="fin_codeudor_sueldo" placeholder="Ej: 1500000"></div>
                        </div>
                        <div id="content-act-codeudor-ind" class="form-grid codeudor-sub-content" style="display: none;">
                            <div class="input-group"><label for="fin_codeudor_honorarios">Honorarios (Prom. Mensual)</label><input type="text" inputmode="numeric" id="fin_codeudor_honorarios" name="fin_codeudor_honorarios" placeholder="Promedio de 6 boletas"></div>
                            <div class="input-group"><label for="fin_codeudor_retiros">Retiros</label><input type="text" inputmode="numeric" id="fin_codeudor_retiros" name="fin_codeudor_retiros" placeholder="Si es dueño de empresa"></div>
                        </div>
                        <div class="form-grid" style="margin-top: 10px;">
                            <div class="input-group"><label for="fin_codeudor_arriendos">Arriendos (Ingreso)</label><input type="text" inputmode="numeric" id="fin_codeudor_arriendos" name="fin_codeudor_arriendos"></div>
                        </div>
                    </div>

                    <div id="tab-pasivos" class="tab-content">
                        <h3>Antecedentes de Deudas (Pasivos de ambos)</h3>
                        <p>Informa las deudas principales (tuyas y/o de tu codeudor).</p>
                        
                        <h4>Crédito Hipotecario (si tienes)</h4>
                        <div class="form-grid">
                            <div class="input-group"><label for="deuda_hip_institucion">Institución</label><input type="text" id="deuda_hip_institucion" name="deuda_hip_institucion" placeholder="Ej: Banco Santander"></div>
                            <div class="input-group"><label for="deuda_hip_cuota">Cuota Mensual</label><input type="text" inputmode="numeric" id="deuda_hip_cuota" name="deuda_hip_cuota" placeholder="Ej: 450000"></div>
                            <div class="input-group"><label for="deuda_hip_saldo">Saldo Deuda Total</label><input type="text" inputmode="numeric" id="deuda_hip_saldo" name="deuda_hip_saldo" placeholder="Ej: 50000000"></div>
                        </div>
                        <h4 style="margin-top: 20px;">Créditos de Consumo</h4>
                        <div class="form-grid">
                            <div class="input-group"><label for="deuda_con1_institucion">Consumo 1: Institución</label><input type="text" id="deuda_con1_institucion" name="deuda_con1_institucion" placeholder="Ej: BCI"></div>
                            <div class="input-group"><label for="deuda_con1_cuota">Cuota</label><input type="text" inputmode="numeric" id="deuda_con1_cuota" name="deuda_con1_cuota" placeholder="Ej: 150000"></div>
                            <div class="input-group"><label for="deuda_con1_saldo">Saldo Deuda</label><input type="text" inputmode="numeric" id="deuda_con1_saldo" name="deuda_con1_saldo" placeholder="Ej: 2500000"></div>
                        </div>
                        <div class="form-grid" style="margin-top: 10px;">
                            <div class="input-group"><label for="deuda_con2_institucion">Consumo 2: Institución</label><input type="text" id="deuda_con2_institucion" name="deuda_con2_institucion" placeholder="Ej: Falabella"></div>
                            <div class="input-group"><label for="deuda_con2_cuota">Cuota</label><input type="text" inputmode="numeric" id="deuda_con2_cuota" name="deuda_con2_cuota"></div>
                            <div class="input-group"><label for="deuda_con2_saldo">Saldo Deuda</label><input type="text" inputmode="numeric" id="deuda_con2_saldo" name="deuda_con2_saldo"></div>
                        </div>
                        <h4 style="margin-top: 20px;">Tarjetas y Líneas de Crédito</h4>
                         <div class="form-grid">
                            <div class="input-group"><label for="deuda_tarjeta_total">Cupo Total Utilizado (Tarjetas)</label><input type="text" inputmode="numeric" id="deuda_tarjeta_total" name="deuda_tarjeta_total" placeholder="Suma de todas tus tarjetas"></div>
                            <div class="input-group"><label for="deuda_linea_total">Cupo Total Utilizado (Líneas de Crédito)</label><input type="text" inputmode="numeric" id="deuda_linea_total" name="deuda_linea_total" placeholder="Suma de todas tus líneas"></div>
                        </div>
                    </div>

                    <div class="form-navigation-buttons">
                        <button type="button" class="form-nav-btn secondary" id="btn-form-prev" style="display: none;">&laquo; Anterior</button>
                        <button type="button" class="form-nav-btn" id="btn-form-next">Siguiente &raquo;</button>
                        <button type="button" class="form-nav-btn" id="btn-finalizar-formulario" style="display: none;">¡Listo! Ir a Subir Archivos &raquo;</button>
                    </div>
                </form>
            </div>

            <div id="paso-3-checklist">
                <h2>Paso 3: Tu Checklist de Documentos</h2>
                <p>¡Perfecto! Ya tenemos tus datos. Ahora, basado en tu perfil, solo necesitamos los siguientes archivos:</p>
                <ul id="checklist-final" class="checklist">
                </ul>
            </div>

            <div id="paso-4-uploader">
                <h2>Paso 4: Sube tus archivos</h2>
                <p>Sube aquí todos los documentos de la lista anterior (PDF, JPG, PNG).</p>
                
                <form id="uploadForm">
                    <div class="input-group">
                        <label for="fileInput">Haz clic aquí o arrastra tus archivos:</label>
                        <input type="file" id="fileInput" name="files" multiple required>
                        <div id="fileList" class="file-list"></div>
                    </div>
                    
                    <button type="submit" id="submitButton">Subir Formulario y Archivos</button>
                    
                    <div id="loadingMessage" style="display:none;">Subiendo todo... esto puede tardar un minuto.</div>
                    <div id="successMessage" style="display:none; color: green;">¡Sistema completo! Recibimos tus datos y archivos. Te contactaremos pronto.</div>
                    <div id="errorMessage" style="display:none; color: red;">Hubo un error. Intenta de nuevo.</div>
                </form>
            </div>
        </div>
    </div>

    <script>
        // ¡¡¡ ATENCIÓN AQUÍ !!!
        // Pega la URL de tu *segundo* script (el de UPLOAD a Drive)
        const URL_SCRIPT_UPLOAD = "https://script.google.com/macros/s/AKfycbxO56Ws-bdkEiv-sCQZgnldzxGd-Ve-gVAVX1vSpbOsTiNrIYLVU9IYAOP8jMzH24gc/exec";

        // --- B. LÓGICA DE UX (El Asistente v3.4) ---

        // ¡NUEVO! Datos para Regiones y Comunas
        const regionesYComunas = {
            "regiones": [
                {"nombre": "Arica y Parinacota", "comunas": ["Arica", "Camarones", "Putre", "General Lagos"]},
                {"nombre": "Tarapacá", "comunas": ["Iquique", "Alto Hospicio", "Pozo Almonte", "Camiña", "Colchane", "Huara", "Pica"]},
                {"nombre": "Antofagasta", "comunas": ["Antofagasta", "Mejillones", "Sierra Gorda", "Taltal", "Calama", "Ollagüe", "San Pedro de Atacama", "Tocopilla", "María Elena"]},
                {"nombre": "Atacama", "comunas": ["Copiapó", "Caldera", "Tierra Amarilla", "Chañaral", "Diego de Almagro", "Vallenar", "Alto del Carmen", "Freirina", "Huasco"]},
                {"nombre": "Coquimbo", "comunas": ["La Serena", "Coquimbo", "Andacollo", "La Higuera", "Paiguano", "Vicuña", "Illapel", "Canela", "Los Vilos", "Salamanca", "Ovalle", "Combarbalá", "Monte Patria", "Punitaqui", "Río Hurtado"]},
                {"nombre": "Valparaíso", "comunas": ["Valparaíso", "Casablanca", "Concón", "Juan Fernández", "Puchuncaví", "Quintero", "Viña del Mar", "Isla de Pascua", "Los Andes", "Calle Larga", "Rinconada", "San Esteban", "La Ligua", "Cabildo", "Papudo", "Petorca", "Zapallar", "Quillota", "Calera", "Hijuelas", "La Cruz", "Nogales", "San Antonio", "Algarrobo", "Cartagena", "El Quisco", "El Tabo", "Santo Domingo", "San Felipe", "Catemu", "Llaillay", "Panquehue", "Putaendo", "Santa María", "Quilpué", "Limache", "Olmué", "Villa Alemana"]},
                {"nombre": "Metropolitana de Santiago", "comunas": ["Santiago", "Cerrillos", "Cerro Navia", "Conchalí", "El Bosque", "Estación Central", "Huechuraba", "Independencia", "La Cisterna", "La Florida", "La Granja", "La Pintana", "La Reina", "Las Condes", "Lo Barnechea", "Lo Espejo", "Lo Prado", "Macul", "Maipú", "Ñuñoa", "Pedro Aguirre Cerda", "Peñalolén", "Providencia", "Pudahuel", "Quilicura", "Quinta Normal", "Recoleta", "Renca", "San Joaquín", "San Miguel", "San Ramón", "Vitacura", "Puente Alto", "Pirque", "San José de Maipo", "Colina", "Lampa", "Tiltil", "San Bernardo", "Buin", "Calera de Tango", "Paine", "Melipilla", "Alhué", "Curacaví", "María Pinto", "San Pedro", "Talagante", "El Monte", "Isla de Maipo", "Padre Hurtado", "Peñaflor"]},
                {"nombre": "O'Higgins", "comunas": ["Rancagua", "Codegua", "Coinco", "Coltauco", "Doñihue", "Graneros", "Las Cabras", "Machalí", "Malloa", "Mostazal", "Olivar", "Peumo", "Pichidegua", "Quinta de Tilcoco", "Rengo", "Requínoa", "San Vicente", "Pichilemu", "La Estrella", "Litueche", "Marchihue", "Navidad", "Paredones", "San Fernando", "Chépica", "Chimbarongo", "Lolol", "Nancagua", "Palmilla", "Peralillo", "Placilla", "Pumanque", "Santa Cruz"]},
                {"nombre": "Maule", "comunas": ["Talca", "Constitución", "Curepto", "Empedrado", "Maule", "Pelarco", "Pencahue", "Río Claro", "San Clemente", "San Rafael", "Cauquenes", "Chanco", "Pelluhue", "Curicó", "Hualañé", "Licantén", "Molina", "Rauco", "Romeral", "Sagrada Familia", "Teno", "Vichuquén", "Linares", "Colbún", "Longaví", "Parral", "Retiro", "San Javier", "Villa Alegre", "Yerbas Buenas"]},
                {"nombre": "Ñuble", "comunas": ["Chillán", "Bulnes", "Chillán Viejo", "El Carmen", "Pemuco", "Pinto", "Quillón", "San Ignacio", "Yungay", "Quirihue", "Cobquecura", "Coelemu", "Ninhue", "Portezuelo", "Ránquil", "Treguaco", "San Carlos", "Coihueco", "Ñiquén", "San Fabián", "San Nicolás"]},
                {"nombre": "Biobío", "comunas": ["Concepción", "Coronel", "Chiguayante", "Florida", "Hualqui", "Lota", "Penco", "San Pedro de la Paz", "Santa Juana", "Talcahuano", "Tomé", "Hualpén", "Lebu", "Arauco", "Cañete", "Contulmo", "Curanilahue", "Los Álamos", "Tirúa", "Los Ángeles", "Antuco", "Cabrero", "Laja", "Mulchén", "Nacimiento", "Negrete", "Quilaco", "Quilleco", "San Rosendo", "Santa Bárbara", "Tucapel", "Yumbel", "Alto Biobío"]},
                {"nombre": "La Araucanía", "comunas": ["Temuco", "Carahue", "Cunco", "Curarrehue", "Freire", "Galvarino", "Gorbea", "Lautaro", "Loncoche", "Melipeuco", "Nueva Imperial", "Padre Las Casas", "Perquenco", "Pitrufquén", "Pucón", "Saavedra", "Teodoro Schmidt", "Toltén", "Vilcún", "Villarrica", "Cholchol", "Angol", "Collipulli", "Curacautín", "Ercilla", "Lonquimay", "Los Sauces", "Lumaco", "Purén", "Renaico", "Traiguén", "Victoria"]},
                {"nombre": "Los Ríos", "comunas": ["Valdivia", "Corral", "Lanco", "Los Lagos", "Máfil", "Mariquina", "Paillaco", "Panguipulli", "La Unión", "Futrono", "Lago Ranco", "Río Bueno"]},
                {"nombre": "Los Lagos", "comunas": ["Puerto Montt", "Calbuco", "Cochamó", "Fresia", "Frutillar", "Los Muermos", "Llanquihue", "Maullín", "Puerto Varas", "Castro", "Ancud", "Chonchi", "Curaco de Vélez", "Dalcahue", "Puqueldón", "Queilén", "Quellón", "Quemchi", "Quinchao", "Osorno", "Puerto Octay", "Purranque", "Puyehue", "Río Negro", "San Juan de la Costa", "San Pablo", "Chaitén", "Futaleufú", "Hualaihué", "Palena"]},
                {"nombre": "Aysén", "comunas": ["Coyhaique", "Lago Verde", "Aysén", "Cisnes", "Guaitecas", "Cochrane", "O'Higgins", "Tortel", "Chile Chico", "Río Ibáñez"]},
                {"nombre": "Magallanes", "comunas": ["Punta Arenas", "Laguna Blanca", "Río Verde", "San Gregorio", "Cabo de Hornos (Ex Navarino)", "Antártica", "Porvenir", "Primavera", "Timaukel", "Natales", "Torres del Paine"]}
            ]
        };

        // Referencias a los Pasos
        const paso1 = document.getElementById('paso-1-perfil');
        const paso2 = document.getElementById('paso-2-formulario');
        const paso3 = document.getElementById('paso-3-checklist');
        const paso4 = document.getElementById('paso-4-uploader');
        
        // Referencias al Perfil (Paso 1)
        const radiosPerfil = document.querySelectorAll('input[name="perfilCliente"]');
        let perfilSeleccionado = "";
        const tabNavLaboralTitular = document.getElementById('tab-nav-laboral-titular');
        const tituloLaboralTitular = document.getElementById('titulo-laboral-titular');
        const contentLabTitularDep = document.getElementById('content-lab-titular-dep');
        const contentLabTitularInd = document.getElementById('content-lab-titular-ind');
        const contentActTitularDep = document.getElementById('content-act-titular-dep');
        const contentActTitularInd = document.getElementById('content-act-titular-ind');

        // Referencias al Formulario (Paso 2)
        const eessForm = document.getElementById('eessForm');
        let tabs = []; 
        let tabNavButtons = []; 
        const btnPrev = document.getElementById('btn-form-prev');
        const btnNext = document.getElementById('btn-form-next');
        const btnFinalizar = document.getElementById('btn-finalizar-formulario');
        let currentTab = 0;
        
        // Referencias al Switch de Codeudor
        const radiosCodeudor = document.querySelectorAll('input[name="complementa_renta"]');
        const codeudorTabs = document.querySelectorAll('.codeudor-tab');
        const codeudorContents = document.querySelectorAll('.tab-content.codeudor-content');
        const perfilCodeudorSelector = document.getElementById('perfil-codeudor-selector');

        // ¡NUEVO! Referencias al Perfil de Codeudor (v3.4)
        const radiosPerfilCodeudor = document.querySelectorAll('input[name="perfilCodeudor"]');
        let perfilCodeudorSeleccionado = "dependiente"; // Default
        const tabNavLaboralCodeudor = document.getElementById('tab-nav-laboral-codeudor');
        const tabNavActivosCodeudor = document.getElementById('tab-nav-activos-codeudor');
        const contentLabCodeudorDep = document.getElementById('content-lab-codeudor-dep');
        const contentLabCodeudorInd = document.getElementById('content-lab-codeudor-ind');
        const contentActCodeudorDep = document.getElementById('content-act-codeudor-dep');
        const contentActCodeudorInd = document.getElementById('content-act-codeudor-ind');


        // Referencias al Checklist (Paso 3)
        const checklistFinal = document.getElementById('checklist-final');
        const TUTORIAL_DEUDA_URL = "tutorial-deuda.pdf"; 
        const LINK_DICOM = "https://www.equifax.cl/ecfx/informe-comercial/dicom-platinum-360";	
        
        // Listas de Documentos
        const documentosComunes = [
            { nombre: "Informe de Deudas CMF", ayuda: TUTORIAL_DEUDA_URL, tipo: "tutorial", textoAyuda: "[Ver Tutorial]" },
            { nombre: "Informe DICOM Platinum 360", ayuda: LINK_DICOM, tipo: "tutorial", textoAyuda: "[Obtener Aquí]" }
        ];
        const documentosDependiente = [
            { nombre: "Cédula de Identidad (ambos lados)" },
            { nombre: "6 últimas liquidaciones de sueldo" },
            { nombre: "12 últimas cotizaciones de AFP" },
            { nombre: "Certificado de antigüedad laboral (o Contrato)" },
            { nombre: "Certificado de Matrimonio / AUC (si aplica)" }
        ];
        const documentosIndependiente = [
            { nombre: "Cédula de Identidad (ambos lados)" },
            { nombre: "Formulario 22 (Declaración Renta 2 últimos años)" },
            { nombre: "Resumen Boletas de Honorarios (2 últimos años)" },
            { nombre: "6 últimos Pagos Provisionales (F29)" },
            { nombre: "Iniciación de Actividades (SII)" }
        ];
        const documentosEmpresa = [
            { nombre: "Cédula de Identidad (Rep. Legal)" },
            { nombre: "RUT de la Empresa" },
            { nombre: "Escritura de la Sociedad (y modificaciones)" },
            { nombre: "Vigencia de Poderes (Rep. Legal)" },
            { nombre: "Nómina de Accionistas (si aplica)" },
            { nombre: "2 últimos Balances (Contador)" },
            { nombre: "12 últimos IVAs (F29)" },
            { nombre: "Carpeta Tributaria (SII)" }
        ];

        
        // --- CEREBRO PASO 1: Selección de Perfil ---
        radiosPerfil.forEach(radio => {
            radio.addEventListener('change', (e) => {
                perfilSeleccionado = e.target.value;
                paso2.style.display = 'block';
                
                // Lógica para cambiar nombre de pestaña y contenido
                if (perfilSeleccionado === 'independiente' || perfilSeleccionado === 'empresa') {
                    tabNavLaboralTitular.textContent = "2. Actividad (Titular)";
                    tituloLaboralTitular.textContent = "Antecedentes de Actividad (Titular)";
                    contentLabTitularDep.style.display = 'none';
                    contentLabTitularInd.style.display = 'grid';
                    contentActTitularDep.style.display = 'none';
                    contentActTitularInd.style.display = 'grid';
                } else { // Dependiente
                    tabNavLaboralTitular.textContent = "2. Laboral (Titular)";
                    tituloLaboralTitular.textContent = "Antecedentes Laborales (Titular)";
                    contentLabTitularDep.style.display = 'grid';
                    contentLabTitularInd.style.display = 'none';
                    contentActTitularDep.style.display = 'grid';
                    contentActTitularInd.style.display = 'none';
                }

                actualizarTabsVisibles(); 
                validarFormulario();
            });
        });

        // --- CEREBRO PASO 2 (Parte A): Lógica del Codeudor ---
        radiosCodeudor.forEach(radio => {
            radio.addEventListener('change', (e) => {
                const showCodeudor = e.target.value === 'si';
                perfilCodeudorSelector.style.display = showCodeudor ? 'block' : 'none'; // Muestra el selector de perfil
                
                // Marcar campos de codeudor como requeridos o no
                codeudorContents.forEach(content => {
                    content.querySelectorAll('input, select').forEach(input => {
                        // Ojo: la lógica de 'required' se afinará en 'actualizarPerfilCodeudor'
                        input.required = showCodeudor;
                    });
                });
                
                actualizarPerfilCodeudor(); // Actualiza campos internos del codeudor
                actualizarTabsVisibles(); // Recalcula las pestañas 4, 5, 6, 7
                validarFormulario();
            });
        });

        // ¡NUEVA FUNCIÓN (v3.4)! --- CEREBRO PERFIL CODEUDOR ---
        radiosPerfilCodeudor.forEach(radio => {
            radio.addEventListener('change', (e) => {
                perfilCodeudorSeleccionado = e.target.value;
                actualizarPerfilCodeudor();
                validarFormulario();
            });
        });

        function actualizarPerfilCodeudor() {
            const esDependiente = perfilCodeudorSeleccionado === 'dependiente';

            // 1. Cambiar nombres de pestañas (si es necesario)
            // (Lo omitimos por ahora para simplicidad, v3.4)

            // 2. Cambiar contenidos de Pestaña 5 (Laboral)
            contentLabCodeudorDep.style.display = esDependiente ? 'grid' : 'none';
            contentLabCodeudorInd.style.display = esDependiente ? 'none' : 'grid';
            
            // 3. Cambiar contenidos de Pestaña 6 (Activos)
            contentActCodeudorDep.style.display = esDependiente ? 'grid' : 'none';
            contentActCodeudorInd.style.display = esDependiente ? 'none' : 'grid';
            
            // 4. Actualizar campos 'required' para la validación
            // Apagamos todos los 'required' primero
            contentLabCodeudorDep.querySelectorAll('input').forEach(i => i.required = false);
            contentLabCodeudorInd.querySelectorAll('input').forEach(i => i.required = false);
            contentActCodeudorDep.querySelectorAll('input').forEach(i => i.required = false);
            contentActCodeudorInd.querySelectorAll('input').forEach(i => i.required = false);

            // Prendemos solo los 'required' del perfil activo
            if (document.querySelector('input[name="complementa_renta"]:checked').value === 'si') {
                if (esDependiente) {
                    contentLabCodeudorDep.querySelectorAll('input').forEach(i => i.required = true); // Asumimos todos son req.
                    contentActCodeudorDep.querySelectorAll('input').forEach(i => i.required = true);
                } else {
                    contentLabCodeudorInd.querySelectorAll('input').forEach(i => i.required = true);
                    contentActCodeudorInd.querySelectorAll('input').forEach(i => i.required = true);
                }
            }
        }


        // --- CEREBRO PASO 2 (Parte B): Navegación y Validación de Pestañas ---
        
        // ¡MOTOR CORREGIDO (v3.4)!
        function actualizarTabsVisibles() {
            const allTabs = Array.from(document.querySelectorAll('.tab-content'));
            const allNavButtons = Array.from(document.querySelectorAll('.tab-nav-button'));
            const showCodeudor = document.querySelector('input[name="complementa_renta"]:checked').value === 'si';

            tabs = [];
            tabNavButtons = [];

            for (let i = 0; i < allTabs.length; i++) {
                const tabContent = allTabs[i];
                const tabButton = allNavButtons[i];

                if (tabButton) {
                    if (tabButton.classList.contains('codeudor-tab')) {
                        if (showCodeudor) {
                            tabs.push(tabContent);
                            tabNavButtons.push(tabButton);
                            tabButton.style.display = 'inline-block';
                        } else {
                            tabButton.style.display = 'none';
                        }
                    } else {
                        tabs.push(tabContent);
                        tabNavButtons.push(tabButton);
                        tabButton.style.display = 'inline-block';
                    }
                }
            }
            
            currentTab = 0; 
            showTab(currentTab);
        }

        function showTab(tabIndex) {
            if (!tabs || tabs.length === 0 || !tabNavButtons || tabNavButtons.length === 0) {
                return; 
            }
            
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-nav-button').forEach(btn => btn.classList.remove('active'));
            
            if (tabs[tabIndex]) {
                tabs[tabIndex].classList.add('active');
            }
            if (tabNavButtons[tabIndex]) {
                tabNavButtons[tabIndex].classList.add('active');
            }

            // Lógica de botones de navegación (v3.4)
            btnPrev.style.display = (tabIndex === 0) ? 'none' : 'inline-block';
            btnNext.style.display = (tabIndex === tabs.length - 1) ? 'none' : 'inline-block';
            btnFinalizar.style.display = (tabIndex === tabs.length - 1) ? 'inline-block' : 'none';
            
            validarFormulario(); 
        }

        document.querySelector('.tab-navigation').addEventListener('click', (e) => {
            if (e.target.classList.contains('tab-nav-button')) {
                let newIndex = tabNavButtons.indexOf(e.target);
                if (newIndex > -1) { 
                    currentTab = newIndex;
                    showTab(currentTab);
                }
            }
        });

        btnNext.addEventListener('click', () => {
            if (currentTab < tabs.length - 1) {
                currentTab++;
                showTab(currentTab);
            }
        });

        btnPrev.addEventListener('click', () => {
            if (currentTab > 0) {
                currentTab--;
                showTab(currentTab);
            }
        });

        // ¡Validación (v3.4 - Verifica Ingreso Principal de AMBOS)!
        eessForm.addEventListener('input', validarFormulario); 

        function validarFormulario() {
            let formValido = true;
            
            // 1. Validar campos básicos del titular
            document.querySelectorAll('#tab-titular input[required], #tab-titular select[required]').forEach(input => {
                if (!input.value) formValido = false;
            });
            
            // 2. Validar ingreso principal TITULAR
            if (!perfilSeleccionado) {
                formValido = false;
            } else {
                if (perfilSeleccionado === 'dependiente' && !document.getElementById('fin_titular_sueldo').value) formValido = false;
                if (perfilSeleccionado === 'independiente' && !document.getElementById('fin_titular_honorarios').value) formValido = false;
                if (perfilSeleccionado === 'empresa' && !document.getElementById('fin_titular_retiros').value) formValido = false;
            }

            // 3. Validar campos de codeudor
            if (document.querySelector('input[name="complementa_renta"]:checked').value === 'si') {
                // Campos básicos
                document.querySelectorAll('#tab-codeudor input[required], #tab-codeudor select[required]').forEach(input => {
                    if (input.required && !input.value) formValido = false;
                });
                
                // ¡NUEVO! Validar ingreso principal CODEUDOR
                if (perfilCodeudorSeleccionado === 'dependiente') {
                    if (!document.getElementById('fin_codeudor_sueldo').value) formValido = false;
                    // Validar campos laborales dependiente
                    contentLabCodeudorDep.querySelectorAll('input').forEach(i => { if(i.required && !i.value) formValido = false; });
                } else { // Independiente
                    if (!document.getElementById('fin_codeudor_honorarios').value && !document.getElementById('fin_codeudor_retiros').value) formValido = false; // Al menos uno
                    // Validar campos laborales independiente
                    contentLabCodeudorInd.querySelectorAll('input').forEach(i => { if(i.required && !i.value) formValido = false; });
                }
            }

            btnFinalizar.disabled = !formValido;
        }

        // --- CEREBRO PASO 3: Finalizar Formulario y Mostrar Checklist ---
        btnFinalizar.addEventListener('click', () => {
            if (btnFinalizar.disabled) return; 

            paso2.style.display = 'none';
            // ¡NUEVO! Checklist ahora depende de AMBOS perfiles
            generarChecklist(perfilSeleccionado, document.querySelector('input[name="complementa_renta"]:checked').value === 'si', perfilCodeudorSeleccionado);
            paso3.style.display = 'block';
            paso4.style.display = 'block';
        });

        function generarChecklist(perfilTitular, hayCodeudor, perfilCodeudor) {
            let listaAMostrar = [];
            
            // 1. Lista del Titular
            if (perfilTitular === 'empresa') {
                listaAMostrar = [...documentosComunes, ...documentosEmpresa];
            } else {
                listaAMostrar = (perfilTitular === 'dependiente') ? 
                    [...documentosComunes, ...documentosDependiente] : 
                    [...documentosComunes, ...documentosIndependiente];
            }
            
            // 2. ¡NUEVO! Lista del Codeudor (si existe)
            if (hayCodeudor) {
                let listaCodeudor = [];
                if (perfilCodeudor === 'dependiente') {
                     listaCodeudor = [
                        { nombre: "--- DOCUMENTOS CODEUDOR (Dependiente) ---" },
                        ...documentosDependiente
                    ];
                } else { // Independiente
                     listaCodeudor = [
                        { nombre: "--- DOCUMENTOS CODEUDOR (Independiente) ---" },
                        ...documentosIndependiente
                    ];
                }
                listaAMostrar = [...listaAMostrar, ...listaCodeudor];
            }
            
            checklistFinal.innerHTML = ''; 
            listaAMostrar.forEach(doc => {
                let linkAyuda = "";
                if (doc.ayuda) {
                    const target = doc.tipo === 'tutorial' ? 'target="_blank"' : 'download';
                    linkAyuda = `<a href="${doc.ayuda}" class="doc-help" ${target}>${doc.textoAyuda}</a>`;
                }
                checklistFinal.innerHTML += `<li><strong>${doc.nombre}</strong> ${linkAyuda}</li>`;
            });
        }


        // --- CEREBRO PASO 4: LÓGICA DE UPLOAD ---
        
        const uploadForm = document.getElementById('uploadForm');
        const fileInput = document.getElementById('fileInput');
        const fileList = document.getElementById('fileList');
        const submitButton = document.getElementById('submitButton');
        const loadingMessage = document.getElementById('loadingMessage');
        const successMessage = document.getElementById('successMessage');
        const errorMessage = document.getElementById('errorMessage');

        fileInput.addEventListener('change', () => {
            fileList.innerHTML = '';
            for (const file of fileInput.files) {
                fileList.innerHTML += `<div>${file.name}</div>`;
            }
        });

        uploadForm.addEventListener('submit', function(e) {
            e.preventDefault();
            submitButton.disabled = true;
            loadingMessage.style.display = 'block';
            successMessage.style.display = 'none';
            errorMessage.style.display = 'none';

            const params = new URLSearchParams(window.location.search);
            const email = params.get('email');
            if (!email) {
                errorMessage.innerText = "Error: No se encontró ID de cliente. El link parece estar roto.";
                errorMessage.style.display = 'block';
                loadingMessage.style.display = 'none';
                return;
            }

            const formData = new FormData(eessForm);
            const eessData = {};
            for (let [key, value] of formData.entries()) {
                if (value) { eessData[key] = value; }
            }

            const files = fileInput.files;
            const fileReaders = [];
            let filesArray = [];

            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                const reader = new FileReader();
                fileReaders.push(new Promise((resolve, reject) => {
                    reader.onload = () => {
                        const base64Data = reader.result.split(',')[1];
                        filesArray.push({ fileName: file.name, mimeType: file.type, data: base64Data });
                        resolve();
                    };
                    reader.onerror = reject;
                    reader.readAsDataURL(file);
                }));
            }

            Promise.all(fileReaders)
                .then(() => {
                    const payload = {
                        email: email,
                        perfil: perfilSeleccionado,
                        perfilCodeudor: hayCodeudor ? perfilCodeudorSeleccionado : "no_aplica", // ¡NUEVO!
                        formData: eessData, 
                        files: filesArray     
                    };

                    fetch(URL_SCRIPT_UPLOAD, {
                        method: 'POST',
                        body: JSON.stringify(payload),
                        headers: { 'Content-Type': 'text/plain;charset=utf-8' }
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.status === 'success') {
                            loadingMessage.style.display = 'none';
                            successMessage.style.display = 'block';
                            uploadForm.reset();
                            fileList.innerHTML = '';
                            paso3.style.display = 'none';
                            paso4.style.display = 'none';
                            // Ocultamos el Paso 2 por si acaso
                            paso2.style.display = 'none'; 
                            // Reseteamos el Paso 1 para mostrar el mensaje de éxito
                            paso1.innerHTML = "<h2>¡Sistema completo!</h2><p>Recibimos tus datos y archivos. Gracias por tu tiempo, te contactaremos a la brevedad.</p>";
                            paso1.style.display = 'block'; // Nos aseguramos que sea visible
                        } else { throw new Error(data.message); }
                    })
                    .catch(error => {
                        errorMessage.innerText = "Error al subir los archivos: " + error.message;
                        errorMessage.style.display = 'block';
                        loadingMessage.style.display = 'none';
                        submitButton.disabled = false;
                    });
                })
                .catch(error => {
                    errorMessage.innerText = "Error al leer los archivos locales.";
                    errorMessage.style.display = 'block';
                    loadingMessage.style.display = 'none';
                    submitButton.disabled = false;
                });
        });

        // --- ¡NUEVAS FUNCIONES DE UX (v3.4)! ---

        // Función para formatear RUT
        function formatearRUT(input) {
            let rut = input.value.replace(/[^0-9kK]/g, ''); 
            if (rut.length > 1) {
                let cuerpo = rut.slice(0, -1);
                let dv = rut.slice(-1);
                cuerpo = cuerpo.replace(/\B(?=(\d{3})+(?!\d))/g, '.'); 
                input.value = cuerpo + '-' + dv.toUpperCase(); // DV en mayúscula
            } else {
                input.value = rut.toUpperCase();
            }
        }

        // Función para cargar Regiones y Comunas
        function cargarRegionesYComunas() {
            const regionSelect = document.getElementById('titular_region');
            const comunaSelect = document.getElementById('titular_comuna');

            regionSelect.innerHTML = '<option value="">Selecciona Región...</option>'; 
            regionesYComunas.regiones.forEach((region, index) => {
                regionSelect.innerHTML += `<option value="${index}">${region.nombre}</option>`;
            });

            regionSelect.addEventListener('change', () => {
                comunaSelect.innerHTML = '<option value="">Selecciona Comuna...</option>'; 
                const regionIndex = regionSelect.value;
                if (regionIndex) {
                    regionesYComunas.regiones[regionIndex].comunas.forEach(comuna => {
                        comunaSelect.innerHTML += `<option value="${comuna}">${comuna}</option>`;
                    });
                }
            });
            // Hacemos que "Metropolitana" sea la opción por defecto
            const rmIndex = regionesYComunas.regiones.findIndex(r => r.nombre === "Metropolitana de Santiago");
            if (rmIndex > -1) {
                regionSelect.value = rmIndex;
                regionSelect.dispatchEvent(new Event('change')); // Disparamos el evento para cargar las comunas
            }
        }

        // --- INICIALIZACIÓN DE LA PÁGINA ---

        // Cargar Regiones y Comunas al iniciar
        cargarRegionesYComunas();
        // Disparar las lógicas de ocultar/mostrar campos dinámicos
        actualizarPerfilCodeudor();
        // Validar el formulario al cargar
        validarFormulario();

    </script>

</body>
</html>