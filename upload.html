<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Carga de Documentos - Evaluaci√≥n</title>
    
    <link rel="icon" href="https://cdn-icons-png.flaticon.com/512/921/921591.png" type="image/png">
    <meta property="og:title" content="Portal Seguro de Carga üîí">
    
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-3RKEMBN9NK"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-3RKEMBN9NK');
    </script>

    <script>
    !function(f,b,e,v,n,t,s)
    {if(f.fbq)return;n=f.fbq=function(){n.callMethod?
    n.callMethod.apply(n,arguments):n.queue.push(arguments)};
    if(!f._fbq)f._fbq=n;n.push=n;n.loaded=!0;n.version='2.0';
    n.queue=[];t=b.createElement(e);t.async=!0;
    t.src=v;s=b.getElementsByTagName(e)[0];
    s.parentNode.insertBefore(t,s)}(window, document,'script',
    'https://connect.facebook.net/en_US/fbevents.js');
    fbq('init', '707966595166662');
    fbq('track', 'PageView');
    </script>
    <noscript><img height="1" width="1" style="display:none"
    src="https://www.facebook.com/tr?id=707966595166662&ev=PageView&noscript=1"
    /></noscript>
    <link href="https://fonts.googleapis.com/css2?family=Lato:wght@400;700&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="/style.css"> 
    
    <style>
        /* Estilos funcionales espec√≠ficos */
        #paso-2-formulario, #paso-3-checklist, #paso-4-uploader, 
        .codeudor-tab, .codeudor-sub-content, #perfil-codeudor-selector, 
        #btn-finalizar-formulario, #loadingMessage, #successMessage, #errorMessage { 
            display: none; 
        }
        /* Ajuste para m√≥viles */
        input, select, textarea { font-size: 16px !important; }
    </style>
</head>
<body>

    <div class="promo-bar">
        üî• Evaluaci√≥n Prioritaria en Curso
    </div>

    <div class="container-upload">
        <div class="form-col">

            <div id="paso-1-perfil">
                <h2>Paso 1: Armemos tu Perfil</h2>
                <p>Para encontrar el mejor cr√©dito para ti, necesito saber c√≥mo generas tus ingresos hoy.</p>
                <div class="profile-selector">
                    <label><input type="radio" name="perfilCliente" value="dependiente"><span>Soy Trabajador <strong>Dependiente</strong> (con contrato)</span></label>
                    <label><input type="radio" name="perfilCliente" value="independiente"><span>Soy Trabajador <strong>Independiente</strong> (boletas)</span></label>
                    <label><input type="radio" name="perfilCliente" value="empresa"><span>Soy <strong>Empresa</strong> (tengo mi propia sociedad)</span></label>
                </div>
            </div>

            <div id="paso-2-formulario">
                <h2>Paso 2: Tu Realidad Financiera</h2>
                <p>Estos datos son clave para ver cu√°nto nos presta el banco. Complem√©ntalos con precisi√≥n.</p>
                
                <form id="eessForm">
                    <div class="tab-navigation">
                        <button type="button" class="tab-nav-button active" data-tab="tab-titular">1. Titular</button>
                        <button type="button" class="tab-nav-button" data-tab="tab-laboral-titular" id="tab-nav-laboral-titular">2. Laboral</button>
                        <button type="button" class="tab-nav-button" data-tab="tab-activos-titular">3. Activos</button>
                        <button type="button" class="tab-nav-button codeudor-tab" data-tab="tab-codeudor">4. Codeudor</button>
                        <button type="button" class="tab-nav-button codeudor-tab" data-tab="tab-laboral-codeudor" id="tab-nav-laboral-codeudor">5. Laboral (Cod.)</button>
                        <button type="button" class="tab-nav-button codeudor-tab" data-tab="tab-activos-codeudor" id="tab-nav-activos-codeudor">6. Activos (Cod.)</button>
                        <button type="button" class="tab-nav-button" data-tab="tab-pasivos">Deudas</button>
                    </div>

                    <div id="tab-titular" class="tab-content active">
                        <h3>Datos Personales</h3>
                        <div class="form-grid">
                            <div class="input-group"><label>Nombre Completo</label><input type="text" id="titular_nombre" name="titular_nombre" required></div>
                            <div class="input-group"><label>RUT</label><input type="text" id="titular_rut" name="titular_rut" placeholder="Ej: 12.345.678-9" required oninput="formatearRUT(this)"></div>
                            <div class="input-group"><label>Email</label><input type="email" id="titular_email" name="titular_email" required></div>
                            <div class="input-group"><label>Tel√©fono</label><input type="tel" id="titular_telefono" name="titular_telefono" placeholder="+569..." required></div>
                            <div class="input-group"><label>Fecha Nacimiento</label><input type="date" id="titular_fecha_nac" name="titular_fecha_nac"></div>
                            <div class="input-group"><label>Nacionalidad</label><select id="titular_nacionalidad" name="titular_nacionalidad"><option value="">Selecciona...</option><option value="Chilena">Chilena</option><option value="Extranjera">Extranjera</option></select></div>
                            <div class="input-group"><label>Estado Civil</label><select id="titular_estado_civil" name="titular_estado_civil"><option value="">Selecciona...</option><option value="Soltero(a)">Soltero(a)</option><option value="Casado(a)">Casado(a)</option><option value="Divorciado(a)">Divorciado(a)</option><option value="Viudo(a)">Viudo(a)</option><option value="AUC">Acuerdo de Uni√≥n Civil</option></select></div>
                            <div class="input-group"><label>R√©gimen conyugal</label><select id="titular_regimen" name="titular_regimen"><option value="">Selecciona...</option><option value="Separaci√≥n de Bienes">Separaci√≥n de Bienes</option><option value="Sociedad Conyugal">Sociedad Conyugal</option><option value="Participaci√≥n en Gananciales">Participaci√≥n en Gananciales</option><option value="No Aplica">No Aplica</option></select></div>
                            <div class="input-group"><label>Domicilio Particular</label><input type="text" id="titular_domicilio" name="titular_domicilio"></div>
                            <div class="input-group"><label>Regi√≥n</label><select id="titular_region" name="titular_region"></select></div>
                            <div class="input-group"><label>Comuna</label><select id="titular_comuna" name="titular_comuna"></select></div>
                            <div class="input-group"><label>Profesi√≥n</label><input type="text" id="titular_profesion" name="titular_profesion"></div>
                        </div>
                        
                        <div style="margin-top: 30px; padding: 20px; background: #f0f4f8; border-radius: 10px;">
                            <h3 style="margin-top: 0; border: none;">¬øHay alguien m√°s en la compra?</h3>
                            <p style="font-size: 0.9em;">Si compras con pareja o socio (codeudor), marca "S√≠" para evaluar ambos ingresos.</p>
                            <div class="profile-selector" style="flex-direction: row; gap: 20px;">
                                <label><input type="radio" name="complementa_renta" value="no" checked><span>No, voy solo</span></label>
                                <label><input type="radio" name="complementa_renta" value="si"><span><strong>S√≠</strong>, complemento</span></label>
                            </div>
                        </div>
                    </div>

                    <div id="tab-laboral-titular" class="tab-content">
                        <h3 id="titulo-laboral-titular">Antecedentes Laborales</h3>
                        <div id="content-lab-titular-dep" class="form-grid">
                            <div class="input-group"><label>Empleador Actual</label><input type="text" id="lab_titular_empleador" name="lab_titular_empleador"></div>
                            <div class="input-group"><label>RUT Empleador</label><input type="text" id="lab_titular_rut_empleador" name="lab_titular_rut_empleador" oninput="formatearRUT(this)"></div>
                            <div class="input-group"><label>Cargo</label><input type="text" id="lab_titular_cargo_dep" name="lab_titular_cargo"></div>
                            <div class="input-group"><label>Tel√©fono Laboral</label><input type="tel" id="lab_titular_telefono" name="lab_titular_telefono"></div>
                            <div class="input-group"><label>Direcci√≥n Laboral</label><input type="text" id="lab_titular_direccion" name="lab_titular_direccion"></div>
                            <div class="input-group"><label>Fecha Ingreso (Antig√ºedad)</label><input type="date" id="lab_titular_fecha_ingreso" name="lab_titular_fecha_ingreso"></div>
                        </div>
                        <div id="content-lab-titular-ind" class="form-grid" style="display: none;">
                            <div class="input-group"><label>Actividad Econ√≥mica</label><input type="text" id="lab_titular_actividad" name="lab_titular_actividad"></div>
                            <div class="input-group"><label>Fecha Inicio Actividades</label><input type="date" id="lab_titular_fecha_ia" name="lab_titular_fecha_ia"></div>
                        </div>
                    </div>

                    <div id="tab-activos-titular" class="tab-content">
                        <h3>Tus Ingresos Mensuales</h3>
                        <div id="content-act-titular-dep" class="form-grid">
                            <div class="input-group"><label>Sueldo L√≠quido</label><input type="text" inputmode="numeric" id="fin_titular_sueldo" name="fin_titular_sueldo" placeholder="$"></div>
                        </div>
                        <div id="content-act-titular-ind" class="form-grid" style="display: none;">
                            <div class="input-group"><label>Honorarios (Promedio Mensual)</label><input type="text" inputmode="numeric" id="fin_titular_honorarios" name="fin_titular_honorarios" placeholder="$"></div>
                            <div class="input-group"><label>Retiros (Si tienes empresa)</label><input type="text" inputmode="numeric" id="fin_titular_retiros" name="fin_titular_retiros" placeholder="$"></div>
                        </div>
                        <div class="form-grid" style="margin-top: 20px;">
                           <div class="input-group"><label>Otros Ingresos (Ej: Arriendos)</label><input type="text" inputmode="numeric" id="fin_titular_arriendos" name="fin_titular_arriendos" placeholder="$"></div>
                        </div>
                        <h3 style="margin-top: 30px;">Tu Ahorro (Pie)</h3>
                        <div class="form-grid">
                            <div class="input-group"><label>Cta. Ahorro / Vista</label><input type="text" inputmode="numeric" id="fin_titular_ahorros" name="fin_titular_ahorros" placeholder="$"></div>
                            <div class="input-group"><label>Dep√≥sitos a Plazo</label><input type="text" inputmode="numeric" id="fin_titular_dap" name="fin_titular_dap" placeholder="$"></div>
                            <div class="input-group"><label>Fondos Mutuos / Acciones</label><input type="text" inputmode="numeric" id="fin_titular_ffmm" name="fin_titular_ffmm" placeholder="$"></div>
                        </div>
                    </div>

                    <div id="tab-codeudor" class="tab-content">
                        <h3>Datos del Codeudor</h3>
                        <div class="form-grid">
                            <div class="input-group"><label>Nombre Completo</label><input type="text" id="codeudor_nombre" name="codeudor_nombre"></div>
                            <div class="input-group"><label>RUT</label><input type="text" id="codeudor_rut" name="codeudor_rut" placeholder="Ej: 12.345.678-9" oninput="formatearRUT(this)"></div>
                            <div class="input-group"><label>Email</label><input type="email" id="codeudor_email" name="codeudor_email"></div>
                            <div class="input-group"><label>Tel√©fono</label><input type="tel" id="codeudor_telefono" name="codeudor_telefono"></div>
                            <div class="input-group"><label>Fecha Nacimiento</label><input type="date" id="codeudor_fecha_nac" name="codeudor_fecha_nac"></div>
                            <div class="input-group"><label>Profesi√≥n</label><input type="text" id="codeudor_profesion" name="codeudor_profesion"></div>
                        </div>
                        <div id="perfil-codeudor-selector" style="margin-top: 30px; padding: 20px; background: #f0f4f8; border-radius: 10px;">
                            <h3 style="margin-top: 0; border: none;">¬øCu√°l es su perfil laboral?</h3>
                            <div class="profile-selector">
                                <label><input type="radio" name="perfilCodeudor" value="dependiente" checked><span>Es Trabajador <strong>Dependiente</strong></span></label>
                                <label><input type="radio" name="perfilCodeudor" value="independiente"><span>Es Trabajador <strong>Independiente</strong></span></label>
                            </div>
                        </div>
                    </div>

                    <div id="tab-laboral-codeudor" class="tab-content">
                        <h3 id="titulo-laboral-codeudor">Antecedentes Laborales (Codeudor)</h3>
                        <div id="content-lab-codeudor-dep" class="form-grid codeudor-sub-content">
                            <div class="input-group"><label>Empleador</label><input type="text" id="lab_codeudor_empleador" name="lab_codeudor_empleador"></div>
                            <div class="input-group"><label>RUT Empleador</label><input type="text" id="lab_codeudor_rut_empleador" name="lab_codeudor_rut_empleador" oninput="formatearRUT(this)"></div>
                            <div class="input-group"><label>Cargo</label><input type="text" id="lab_codeudor_cargo" name="lab_codeudor_cargo"></div>
                            <div class="input-group"><label>Fecha Ingreso</label><input type="date" id="lab_codeudor_fecha_ingreso" name="lab_codeudor_fecha_ingreso"></div>
                        </div>
                        <div id="content-lab-codeudor-ind" class="form-grid codeudor-sub-content" style="display: none;">
                            <div class="input-group"><label>Actividad Econ√≥mica</label><input type="text" id="lab_codeudor_actividad" name="lab_codeudor_actividad"></div>
                            <div class="input-group"><label>Inicio Actividades</label><input type="date" id="lab_codeudor_fecha_ia" name="lab_codeudor_fecha_ia"></div>
                        </div>
                    </div>

                    <div id="tab-activos-codeudor" class="tab-content">
                        <h3>Ingresos Codeudor</h3>
                        <div id="content-act-codeudor-dep" class="form-grid codeudor-sub-content">
                            <div class="input-group"><label>Sueldo L√≠quido</label><input type="text" inputmode="numeric" id="fin_codeudor_sueldo" name="fin_codeudor_sueldo" placeholder="$"></div>
                        </div>
                        <div id="content-act-codeudor-ind" class="form-grid codeudor-sub-content" style="display: none;">
                            <div class="input-group"><label>Honorarios</label><input type="text" inputmode="numeric" id="fin_codeudor_honorarios" name="fin_codeudor_honorarios" placeholder="$"></div>
                            <div class="input-group"><label>Retiros</label><input type="text" inputmode="numeric" id="fin_codeudor_retiros" name="fin_codeudor_retiros" placeholder="$"></div>
                        </div>
                        <div class="form-grid" style="margin-top: 10px;">
                            <div class="input-group"><label>Otros Ingresos</label><input type="text" inputmode="numeric" id="fin_codeudor_arriendos" name="fin_codeudor_arriendos" placeholder="$"></div>
                        </div>
                    </div>

                    <div id="tab-pasivos" class="tab-content">
                        <h3>Deudas Vigentes (Total Hogar)</h3>
                        <h4>Cr√©dito Hipotecario</h4>
                        <div class="form-grid">
                            <div class="input-group"><label>Instituci√≥n</label><input type="text" id="deuda_hip_institucion" name="deuda_hip_institucion"></div>
                            <div class="input-group"><label>Cuota Mensual</label><input type="text" inputmode="numeric" id="deuda_hip_cuota" name="deuda_hip_cuota" placeholder="$"></div>
                            <div class="input-group"><label>Saldo por Pagar</label><input type="text" inputmode="numeric" id="deuda_hip_saldo" name="deuda_hip_saldo" placeholder="$"></div>
                        </div>
                        <h4>Cr√©ditos de Consumo</h4>
                        <div class="form-grid">
                            <div class="input-group"><label>Instituci√≥n (1)</label><input type="text" id="deuda_con1_institucion" name="deuda_con1_institucion"></div>
                            <div class="input-group"><label>Cuota</label><input type="text" inputmode="numeric" id="deuda_con1_cuota" name="deuda_con1_cuota" placeholder="$"></div>
                            <div class="input-group"><label>Saldo</label><input type="text" inputmode="numeric" id="deuda_con1_saldo" name="deuda_con1_saldo" placeholder="$"></div>
                        </div>
                        <div class="form-grid" style="margin-top: 10px;">
                            <div class="input-group"><label>Instituci√≥n (2)</label><input type="text" id="deuda_con2_institucion" name="deuda_con2_institucion"></div>
                            <div class="input-group"><label>Cuota</label><input type="text" inputmode="numeric" id="deuda_con2_cuota" name="deuda_con2_cuota"></div>
                            <div class="input-group"><label>Saldo</label><input type="text" inputmode="numeric" id="deuda_con2_saldo" name="deuda_con2_saldo" placeholder="$"></div>
                        </div>
                        <h4>Tarjetas y L√≠neas</h4>
                         <div class="form-grid">
                            <div class="input-group"><label>Cupo Usado (Tarjetas)</label><input type="text" inputmode="numeric" id="deuda_tarjeta_total" name="deuda_tarjeta_total" placeholder="$"></div>
                            <div class="input-group"><label>Cupo Usado (L√≠neas)</label><input type="text" inputmode="numeric" id="deuda_linea_total" name="deuda_linea_total" placeholder="$"></div>
                        </div>
                    </div>

                    <div class="form-navigation-buttons">
                        <button type="button" class="form-nav-btn secondary" id="btn-form-prev" style="display: none;">&laquo; Volver</button>
                        <button type="button" class="form-nav-btn" id="btn-form-next">Siguiente &raquo;</button>
                        <button type="button" class="form-nav-btn" id="btn-finalizar-formulario" style="display: none;">¬°Listo! Ver documentos necesarios &raquo;</button>
                    </div>
                </form>
            </div>

            <div id="paso-3-checklist">
                <h2>Paso 3: Checklist Estrat√©gico</h2>
                <p>Para armar tu carpeta y presentarla al banco, necesito estos documentos exactos:</p>
                <ul id="checklist-final" class="checklist"></ul>
            </div>

            <div id="paso-4-uploader">
                <h2>Paso Final: Env√≠ame tu Carpeta</h2>
                <p>Sube aqu√≠ todos los archivos digitales (PDF, JPG, PNG). Yo me encargo de ordenarlos y evaluar la estrategia.</p>
                <form id="uploadForm">
                    <div class="input-group">
                        <label for="fileInput">Seleccionar Archivos</label>
                        <input type="file" id="fileInput" name="files" multiple required>
                        <div id="fileList" class="file-list"></div>
                    </div>
                    <button type="submit" id="submitButton">ENVIAR Y ACTIVAR EVALUACI√ìN üîí</button>
                    <p style="text-align: center; font-size: 0.85em; color: #666; margin-top: 15px;">
                        Tus antecedentes son 100% confidenciales.
                    </p>
                    <div id="loadingMessage" style="display:none;"><strong>Procesando...</strong> Estoy recibiendo y ordenando tu carpeta.</div>
                    <div id="successMessage" style="display:none; color: green;"><strong>¬°RECIBIDO!</strong> Tu informaci√≥n lleg√≥ perfecta. Revisa tu correo para la confirmaci√≥n.</div>
                    <div id="errorMessage" style="display:none; color: red;">Hubo un error t√©cnico. Por favor intenta nuevamente.</div>
                </form>
            </div>
        </div>
    </div>

    <footer style="background: #000; color: #666; padding: 30px 20px; text-align: center; font-size: 12px; margin-top: 60px; border-top: 1px solid #333;">
        <p style="margin-bottom: 10px;">¬© 2025 Oscar Hern√°ndez - Broker Inmobiliario.</p>
        <p>Tus datos son tratados con estricta confidencialidad y seguridad (SSL).</p>
    </footer>

    <script>
        // ============================================================
        // CONFIGURACI√ìN URL Y DATOS
        // ============================================================
        const URL_SCRIPT_UPLOAD = "https://script.google.com/macros/s/AKfycbxO56Ws-bdkEiv-sCQZgnldzxGd-Ve-gVAVX1vSpbOsTiNrIYLVU9IYAOP8jMzH24gc/exec";
        const TUTORIAL_DEUDA_URL = "tutorial-deuda.pdf";
        const LINK_DICOM = "https://www.equifax.cl/ecfx/informe-comercial/dicom-platinum-360";
        
        const regionesYComunas = { "regiones": [ 
            {"nombre": "Arica y Parinacota", "comunas": ["Arica", "Camarones", "Putre", "General Lagos"]},
            {"nombre": "Tarapaca", "comunas": ["Iquique", "Alto Hospicio", "Pozo Almonte", "Camina", "Colchane", "Huara", "Pica"]},
            {"nombre": "Antofagasta", "comunas": ["Antofagasta", "Mejillones", "Sierra Gorda", "Taltal", "Calama", "Ollague", "San Pedro de Atacama", "Tocopilla", "Maria Elena"]},
            {"nombre": "Atacama", "comunas": ["Copiapo", "Caldera", "Tierra Amarilla", "Chanaral", "Diego de Almagro", "Vallenar", "Alto del Carmen", "Freirina", "Huasco"]},
            {"nombre": "Coquimbo", "comunas": ["La Serena", "Coquimbo", "Andacollo", "La Higuera", "Paiguano", "Vicuna", "Illapel", "Canela", "Los Vilos", "Salamanca", "Ovalle", "Combarbala", "Monte Patria", "Punitaqui", "Rio Hurtado"]},
            {"nombre": "Valparaiso", "comunas": ["Valparaiso", "Casablanca", "Concon", "Juan Fernandez", "Puchuncavi", "Quintero", "Vina del Mar", "Isla de Pascua", "Los Andes", "Calle Larga", "Rinconada", "San Esteban", "La Ligua", "Cabildo", "Papudo", "Petorca", "Zapallar", "Quillota", "Calera", "Hijuelas", "La Cruz", "Nogales", "San Antonio", "Algarrobo", "Cartagena", "El Quisco", "El Tabo", "Santo Domingo", "San Felipe", "Catemu", "Llaillay", "Panquehue", "Putaendo", "Santa Maria", "Quilpue", "Limache", "Olmue", "Villa Alemana"]},
            {"nombre": "Metropolitana de Santiago", "comunas": ["Santiago", "Cerrillos", "Cerro Navia", "Conchali", "El Bosque", "Estacion Central", "Huechuraba", "Independencia", "La Cisterna", "La Florida", "La Granja", "La Pintana", "La Reina", "Las Condes", "Lo Barnechea", "Lo Espejo", "Lo Prado", "Macul", "Maipu", "Nunoa", "Pedro Aguirre Cerda", "Penalolen", "Providencia", "Pudahuel", "Quilicura", "Quinta Normal", "Recoleta", "Renca", "San Joaquin", "San Miguel", "San Ramon", "Vitacura", "Puente Alto", "Pirque", "San Jose de Maipo", "Colina", "Lampa", "Tiltil", "San Bernardo", "Buin", "Calera de Tango", "Paine", "Melipilla", "Alhue", "Curacavi", "Maria Pinto", "San Pedro", "Talagante", "El Monte", "Isla de Maipo", "Padre Hurtado", "Penaflor"]},
            {"nombre": "O Higgins", "comunas": ["Rancagua", "Codegua", "Coinco", "Coltauco", "Donihue", "Graneros", "Las Cabras", "Machali", "Malloa", "Mostazal", "Olivar", "Peumo", "Pichidegua", "Quinta de Tilcoco", "Rengo", "Requinoa", "San Vicente", "Pichilemu", "La Estrella", "Litueche", "Marchihue", "Navidad", "Paredones", "San Fernando", "Chepica", "Chimbarongo", "Lolol", "Nancagua", "Palmilla", "Peralillo", "Placilla", "Pumanque", "Santa Cruz"]},
            {"nombre": "Maule", "comunas": ["Talca", "Constitucion", "Curepto", "Empedrado", "Maule", "Pelarco", "Pencahue", "Rio Claro", "San Clemente", "San Rafael", "Cauquenes", "Chanco", "Pelluhue", "Curico", "Hualane", "Licanten", "Molina", "Rauco", "Romeral", "Sagrada Familia", "Teno", "Vichuquen", "Linares", "Colbun", "Longavi", "Parral", "Retiro", "San Javier", "Villa Alegre", "Yerbas Buenas"]},
            {"nombre": "Nuble", "comunas": ["Chillan", "Bulnes", "Chillan Viejo", "El Carmen", "Pemuco", "Pinto", "Quillon", "San Ignacio", "Yungay", "Quirihue", "Cobquecura", "Coelemu", "Ninhue", "Portezuelo", "Ranquil", "Treguaco", "San Carlos", "Coihueco", "Niquen", "San Fabian", "San Nicolas"]},
            {"nombre": "Biobio", "comunas": ["Concepcion", "Coronel", "Chiguayante", "Florida", "Hualqui", "Lota", "Penco", "San Pedro de la Paz", "Santa Juana", "Talcahuano", "Tome", "Hualpen", "Lebu", "Arauco", "Canete", "Contulmo", "Curanilahue", "Los Alamos", "Tirua", "Los Angeles", "Antuco", "Cabrero", "Laja", "Mulchen", "Nacimiento", "Negrete", "Quilaco", "Quilleco", "San Rosendo", "Santa Barbara", "Tucapel", "Yumbel", "Alto Biobio"]},
            {"nombre": "Araucania", "comunas": ["Temuco", "Carahue", "Cunco", "Curarrehue", "Freire", "Galvarino", "Gorbea", "Lautaro", "Loncoche", "Melipeuco", "Nueva Imperial", "Padre Las Casas", "Perquenco", "Pitrufquen", "Pucon", "Saavedra", "Teodoro Schmidt", "Tolten", "Vilcun", "Villarrica", "Cholchol", "Angol", "Collipulli", "Curacautin", "Ercilla", "Lonquimay", "Los Sauces", "Lumaco", "Puren", "Renaico", "Traiguen", "Victoria"]},
            {"nombre": "Los Rios", "comunas": ["Valdivia", "Corral", "Lanco", "Los Lagos", "Mafil", "Mariquina", "Paillaco", "Panguipulli", "La Union", "Futrono", "Lago Ranco", "Rio Bueno"]},
            {"nombre": "Los Lagos", "comunas": ["Puerto Montt", "Calbuco", "Cochamo", "Fresia", "Frutillar", "Los Muermos", "Llanquihue", "Maullin", "Puerto Varas", "Castro", "Ancud", "Chonchi", "Curaco de Velez", "Dalcahue", "Puqueldon", "Queilen", "Quellon", "Quemchi", "Quinchao", "Osorno", "Puerto Octay", "Purranque", "Puyehue", "Rio Negro", "San Juan de la Costa", "San Pablo", "Chaiten", "Futaleufu", "Hualaihue", "Palena"]},
            {"nombre": "Aysen", "comunas": ["Coyhaique", "Lago Verde", "Aysen", "Cisnes", "Guaitecas", "Cochrane", "O Higgins", "Tortel", "Chile Chico", "Rio Ibanez"]},
            {"nombre": "Magallanes", "comunas": ["Punta Arenas", "Laguna Blanca", "Rio Verde", "San Gregorio", "Cabo de Hornos", "Antartica", "Porvenir", "Primavera", "Timaukel", "Natales", "Torres del Paine"]}
        ] };

        const documentosComunes = [ { nombre: "Informe de Deudas CMF", ayuda: TUTORIAL_DEUDA_URL, tipo: "tutorial", textoAyuda: "[Ver Tutorial]" }, { nombre: "Informe DICOM Platinum 360", ayuda: LINK_DICOM, tipo: "tutorial", textoAyuda: "[Obtener Aqu√≠]" } ];
        const documentosDependiente = [ { nombre: "C√©dula de Identidad (ambos lados)" }, { nombre: "6 √∫ltimas liquidaciones de sueldo" }, { nombre: "12 √∫ltimas cotizaciones de AFP" }, { nombre: "Certificado de antig√ºedad laboral (o Contrato)" }, { nombre: "Certificado de Matrimonio / AUC (si aplica)" } ];
        const documentosIndependiente = [ { nombre: "C√©dula de Identidad (ambos lados)" }, { nombre: "Formulario 22 (Declaraci√≥n Renta 2 √∫ltimos a√±os)" }, { nombre: "Resumen Boletas de Honorarios (2 √∫ltimos a√±os)" }, { nombre: "6 √∫ltimos Pagos Provisionales (F29)" }, { nombre: "Iniciaci√≥n de Actividades (SII)" } ];
        const documentosEmpresa = [ { nombre: "C√©dula de Identidad (Rep. Legal)" }, { nombre: "RUT de la Empresa" }, { nombre: "Escritura de la Sociedad (y modificaciones)" }, { nombre: "Vigencia de Poderes (Rep. Legal)" }, { nombre: "N√≥mina de Accionistas (si aplica)" }, { nombre: "2 √∫ltimos Balances (Contador)" }, { nombre: "12 √∫ltimos IVAs (F29)" }, { nombre: "Carpeta Tributaria (SII)" } ];

        const paso1 = document.getElementById('paso-1-perfil');
        const paso2 = document.getElementById('paso-2-formulario');
        const paso3 = document.getElementById('paso-3-checklist');
        const paso4 = document.getElementById('paso-4-uploader');
        const eessForm = document.getElementById('eessForm');
        const btnPrev = document.getElementById('btn-form-prev');
        const btnNext = document.getElementById('btn-form-next');
        const btnFinalizar = document.getElementById('btn-finalizar-formulario');
        const checklistFinal = document.getElementById('checklist-final');
        const perfilCodeudorSelector = document.getElementById('perfil-codeudor-selector');

        let perfilSeleccionado = "";
        let perfilCodeudorSeleccionado = "dependiente";
        let tabs = []; 
        let tabNavButtons = []; 
        let currentTab = 0;

        document.querySelectorAll('input[name="perfilCliente"]').forEach(r => r.addEventListener('change', (e) => {
            perfilSeleccionado = e.target.value;
            paso2.style.display = 'block';
            actualizarUXTitular();
            actualizarTabsVisibles(); 
            validarFormulario();
        }));

        document.querySelectorAll('input[name="complementa_renta"]').forEach(r => r.addEventListener('change', (e) => {
            const show = e.target.value === 'si';
            perfilCodeudorSelector.style.display = show ? 'block' : 'none';
            actualizarPerfilCodeudor();
            actualizarTabsVisibles();
            validarFormulario();
        }));

        document.querySelectorAll('input[name="perfilCodeudor"]').forEach(r => r.addEventListener('change', (e) => {
            perfilCodeudorSeleccionado = e.target.value;
            actualizarPerfilCodeudor();
            validarFormulario();
        }));

        function actualizarUXTitular() {
            const esIndep = (perfilSeleccionado === 'independiente' || perfilSeleccionado === 'empresa');
            document.getElementById('tab-nav-laboral-titular').textContent = esIndep ? "2. Actividad" : "2. Laboral";
            document.getElementById('content-lab-titular-dep').style.display = esIndep ? 'none' : 'grid';
            document.getElementById('content-lab-titular-ind').style.display = esIndep ? 'grid' : 'none';
            document.getElementById('content-act-titular-dep').style.display = esIndep ? 'none' : 'grid';
            document.getElementById('content-act-titular-ind').style.display = esIndep ? 'grid' : 'none';
        }

        function actualizarPerfilCodeudor() {
            const esDep = perfilCodeudorSeleccionado === 'dependiente';
            document.getElementById('content-lab-codeudor-dep').style.display = esDep ? 'grid' : 'none';
            document.getElementById('content-lab-codeudor-ind').style.display = esDep ? 'none' : 'grid';
            document.getElementById('content-act-codeudor-dep').style.display = esDep ? 'grid' : 'none';
            document.getElementById('content-act-codeudor-ind').style.display = esDep ? 'none' : 'grid';
            document.querySelectorAll('.codeudor-sub-content input').forEach(i => i.required = false);
            if (document.querySelector('input[name="complementa_renta"]:checked').value === 'si') {
                const targetLab = esDep ? 'content-lab-codeudor-dep' : 'content-lab-codeudor-ind';
                const targetAct = esDep ? 'content-act-codeudor-dep' : 'content-act-codeudor-ind';
                document.getElementById(targetLab).querySelectorAll('input').forEach(i => i.required = true);
                document.getElementById(targetAct).querySelectorAll('input').forEach(i => i.required = true);
            }
        }

        function actualizarTabsVisibles() {
            const allTabs = Array.from(document.querySelectorAll('.tab-content'));
            const allNavButtons = Array.from(document.querySelectorAll('.tab-nav-button'));
            const showCodeudor = document.querySelector('input[name="complementa_renta"]:checked').value === 'si';
            tabs = []; tabNavButtons = [];
            for (let i = 0; i < allTabs.length; i++) {
                const btn = allNavButtons[i];
                const content = allTabs[i];
                if (btn) {
                    if (btn.classList.contains('codeudor-tab')) {
                        if (showCodeudor) { tabs.push(content); tabNavButtons.push(btn); btn.style.display = 'inline-block'; }
                        else { btn.style.display = 'none'; }
                    } else { tabs.push(content); tabNavButtons.push(btn); btn.style.display = 'inline-block'; }
                }
            }
            currentTab = 0; showTab(0);
        }

        function showTab(n) {
            if (!tabs.length) return;
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-nav-button').forEach(b => b.classList.remove('active'));
            tabs[n].classList.add('active');
            tabNavButtons[n].classList.add('active');
            btnPrev.style.display = n === 0 ? 'none' : 'inline-block';
            btnNext.style.display = n === tabs.length - 1 ? 'none' : 'inline-block';
            btnFinalizar.style.display = n === tabs.length - 1 ? 'inline-block' : 'none';
        }

        document.querySelector('.tab-navigation').addEventListener('click', (e) => {
            if (e.target.classList.contains('tab-nav-button')) {
                const idx = tabNavButtons.indexOf(e.target);
                if (idx > -1) { currentTab = idx; showTab(currentTab); }
            }
        });
        btnNext.addEventListener('click', () => { if(currentTab < tabs.length -1) { currentTab++; showTab(currentTab); } });
        btnPrev.addEventListener('click', () => { if(currentTab > 0) { currentTab--; showTab(currentTab); } });
        eessForm.addEventListener('input', validarFormulario);

        function validarFormulario() { btnFinalizar.disabled = false; }

        btnFinalizar.addEventListener('click', () => {
            paso2.style.display = 'none';
            generarChecklist();
            paso3.style.display = 'block';
            paso4.style.display = 'block';
        });

        function generarChecklist() {
            const hayCodeudor = document.querySelector('input[name="complementa_renta"]:checked').value === 'si';
            let lista = (perfilSeleccionado === 'empresa') ? [...documentosComunes, ...documentosEmpresa] :
                        (perfilSeleccionado === 'dependiente') ? [...documentosComunes, ...documentosDependiente] : [...documentosComunes, ...documentosIndependiente];
            if (hayCodeudor) {
                lista.push({ nombre: `--- CODEUDOR (${perfilCodeudorSeleccionado.toUpperCase()}) ---` });
                lista = lista.concat((perfilCodeudorSeleccionado === 'dependiente') ? documentosDependiente : documentosIndependiente);
            }
            checklistFinal.innerHTML = '';
            lista.forEach(doc => {
                let link = doc.ayuda ? `<a href="${doc.ayuda}" class="doc-help" target="_blank">${doc.textoAyuda}</a>` : '';
                checklistFinal.innerHTML += `<li><strong>${doc.nombre}</strong> ${link}</li>`;
            });
        }

        const uploadForm = document.getElementById('uploadForm');
        const fileInput = document.getElementById('fileInput');
        const fileList = document.getElementById('fileList');
        const submitButton = document.getElementById('submitButton');
        const loadingMessage = document.getElementById('loadingMessage');
        const successMessage = document.getElementById('successMessage');
        const errorMessage = document.getElementById('errorMessage');

        fileInput.addEventListener('change', () => {
            fileList.innerHTML = '';
            for(const file of fileInput.files) fileList.innerHTML += `<div>${file.name}</div>`;
        });

        const leerArchivo = (file) => {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve({ fileName: file.name, mimeType: file.type, data: reader.result.split(',')[1] });
                reader.onerror = () => reject(new Error(`Error al leer ${file.name}`));
                reader.readAsDataURL(file);
            });
        };

        uploadForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            submitButton.disabled = true;
            loadingMessage.style.display = 'block';
            errorMessage.style.display = 'none';
            successMessage.style.display = 'none';

            try {
                const params = new URLSearchParams(window.location.search);
                const email = params.get('email');
                if (!email) throw new Error("Falta el email en la URL.");

                const formData = new FormData(eessForm);
                const eessData = {};
                formData.forEach((value, key) => eessData[key] = value);

                const files = fileInput.files;
                if (!files.length) throw new Error("Selecciona al menos un archivo.");
                
                const filesArray = await Promise.all(Array.from(files).map(leerArchivo));

                const payload = {
                    email: email,
                    perfil: perfilSeleccionado,
                    perfilCodeudor: document.querySelector('input[name="complementa_renta"]:checked').value === 'si' ? perfilCodeudorSeleccionado : "no_aplica",
                    formData: eessData,
                    files: filesArray
                };

                const response = await fetch(URL_SCRIPT_UPLOAD, {
                    method: 'POST',
                    body: JSON.stringify(payload),
                    headers: { 'Content-Type': 'text/plain;charset=utf-8' } 
                });
                const result = await response.json();

                if (result.status === 'success') {
                    loadingMessage.style.display = 'none';
                    successMessage.style.display = 'block';
                    document.getElementById('paso-1-perfil').style.display = 'none'; 
                    paso3.style.display = 'none';
                    paso4.style.display = 'none';
                } else {
                    throw new Error(result.message);
                }
            } catch (error) {
                console.error(error);
                errorMessage.innerText = "Error: " + error.message;
                errorMessage.style.display = 'block';
                loadingMessage.style.display = 'none';
                submitButton.disabled = false;
            }
        });

        function formatearRUT(input) {
            let rut = input.value.replace(/[^0-9kK]/g, '');
            if (rut.length > 1) {
                input.value = rut.slice(0, -1).replace(/\B(?=(\d{3})+(?!\d))/g, '.') + '-' + rut.slice(-1).toUpperCase();
            } else { input.value = rut.toUpperCase(); }
        }

        function cargarRegionesYComunas() {
            const regionSelect = document.getElementById('titular_region');
            const comunaSelect = document.getElementById('titular_comuna');
            regionSelect.innerHTML = '<option value="">Selecciona...</option>';
            regionesYComunas.regiones.forEach((r, i) => regionSelect.innerHTML += `<option value="${i}">${r.nombre}</option>`);
            regionSelect.addEventListener('change', () => {
                comunaSelect.innerHTML = '<option value="">Selecciona...</option>';
                if (regionSelect.value) regionesYComunas.regiones[regionSelect.value].comunas.forEach(c => comunaSelect.innerHTML += `<option value="${c}">${c}</option>`);
            });
            regionSelect.value = 6; 
            regionSelect.dispatchEvent(new Event('change'));
        }

        cargarRegionesYComunas();
        actualizarUXTitular();
        actualizarPerfilCodeudor();
        validarFormulario();
    </script>
</body>
</html>